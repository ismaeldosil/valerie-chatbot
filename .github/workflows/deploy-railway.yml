# Valerie Supplier Chatbot - Railway Deployment
# Deploys to Railway on push to main branch after CI passes
#
# Required secrets:
#   - RAILWAY_TOKEN: Railway API token
#   - RAILWAY_APP_URL: Deployed app URL (optional, for health checks)

name: Deploy to Railway

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # ===========================================================================
  # Pre-deployment Checks
  # ===========================================================================
  pre-deploy:
    name: Pre-deployment Checks
    runs-on: ubuntu-latest
    # Only run if RAILWAY_TOKEN is configured
    if: ${{ vars.DEPLOY_ENABLED == 'true' || github.event_name == 'workflow_dispatch' }}

    outputs:
      should_deploy: ${{ steps.check.outputs.should_deploy }}
      version: ${{ steps.version.outputs.version }}

    steps:
      - name: Check for Railway token
        run: |
          if [ -z "${{ secrets.RAILWAY_TOKEN }}" ]; then
            echo "::error::RAILWAY_TOKEN secret is not configured"
            echo "Please add RAILWAY_TOKEN in Settings → Secrets → Actions"
            exit 1
          fi

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if deployment should proceed
        id: check
        run: |
          # Check if the commit message contains [skip deploy]
          if git log -1 --pretty=%B | grep -q '\[skip deploy\]'; then
            echo "should_deploy=false" >> $GITHUB_OUTPUT
            echo "Skipping deployment due to [skip deploy] in commit message"
          else
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          fi

      - name: Get version
        id: version
        run: |
          VERSION=$(grep 'version = ' pyproject.toml | head -1 | cut -d'"' -f2)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Deploying version: $VERSION"

  # ===========================================================================
  # Run Tests Before Deploy
  # ===========================================================================
  test:
    name: Verify Tests Pass
    runs-on: ubuntu-latest
    needs: [pre-deploy]
    if: needs.pre-deploy.outputs.should_deploy == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Install dependencies
        run: uv sync --dev

      - name: Run tests
        run: uv run pytest tests/ -x -q --tb=short

  # ===========================================================================
  # Deploy to Railway
  # ===========================================================================
  deploy:
    name: Deploy to Railway
    runs-on: ubuntu-latest
    needs: [pre-deploy, test]
    if: needs.pre-deploy.outputs.should_deploy == 'true'
    environment:
      name: ${{ github.event.inputs.environment || 'production' }}
      url: ${{ steps.deploy.outputs.url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Deploy to Railway
        id: deploy
        run: |
          echo "Deploying to Railway..."
          railway up --service valerie-api --detach

          # Get the deployment URL
          DEPLOY_URL=$(railway status --json | jq -r '.deploymentUrl // "https://valerie-api.railway.app"')
          echo "url=$DEPLOY_URL" >> $GITHUB_OUTPUT
          echo "Deployed to: $DEPLOY_URL"
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      - name: Wait for deployment
        run: |
          echo "Waiting for deployment to be ready..."
          sleep 60

  # ===========================================================================
  # Post-deployment Health Check
  # ===========================================================================
  health-check:
    name: Health Check
    runs-on: ubuntu-latest
    needs: [deploy]

    steps:
      - name: Wait for service to stabilize
        run: sleep 30

      - name: Check health endpoint
        run: |
          HEALTH_URL="${{ secrets.RAILWAY_APP_URL || 'https://valerie-api.railway.app' }}/health"
          echo "Checking health at: $HEALTH_URL"

          for i in {1..5}; do
            if curl -sf "$HEALTH_URL" | jq .; then
              echo "Health check passed!"
              exit 0
            fi
            echo "Attempt $i failed, retrying in 10s..."
            sleep 10
          done

          echo "Health check failed after 5 attempts"
          exit 1

      - name: Check ready endpoint
        run: |
          READY_URL="${{ secrets.RAILWAY_APP_URL || 'https://valerie-api.railway.app' }}/ready"
          echo "Checking readiness at: $READY_URL"
          curl -sf "$READY_URL" | jq .

  # ===========================================================================
  # Notify Deployment Status
  # ===========================================================================
  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: [pre-deploy, deploy, health-check]
    if: always()

    steps:
      - name: Deployment succeeded
        if: needs.health-check.result == 'success'
        run: |
          echo "## Deployment Successful! :rocket:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Version | ${{ needs.pre-deploy.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ github.event.inputs.environment || 'production' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deployed by | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY

      - name: Deployment failed
        if: needs.health-check.result == 'failure'
        run: |
          echo "## Deployment Failed! :x:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Health check failed after deployment." >> $GITHUB_STEP_SUMMARY
          echo "Please check Railway logs for details." >> $GITHUB_STEP_SUMMARY

      # Optional: Slack notification
      - name: Notify Slack on success
        if: needs.health-check.result == 'success' && secrets.SLACK_WEBHOOK_URL != ''
        run: |
          curl -X POST ${{ secrets.SLACK_WEBHOOK_URL }} \
            -H 'Content-type: application/json' \
            -d '{
              "text": "Valerie deployed successfully!",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Valerie Supplier Chatbot* deployed to production :rocket:\n*Version:* ${{ needs.pre-deploy.outputs.version }}\n*Commit:* `${{ github.sha }}`"
                  }
                }
              ]
            }'
        continue-on-error: true
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Notify Slack on failure
        if: needs.health-check.result == 'failure' && secrets.SLACK_WEBHOOK_URL != ''
        run: |
          curl -X POST ${{ secrets.SLACK_WEBHOOK_URL }} \
            -H 'Content-type: application/json' \
            -d '{
              "text": "Valerie deployment failed!",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Valerie Supplier Chatbot* deployment FAILED :x:\n*Commit:* `${{ github.sha }}`\nPlease check GitHub Actions for details."
                  }
                }
              ]
            }'
        continue-on-error: true
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
